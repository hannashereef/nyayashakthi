{% extends "nyayashakthi/base.html" %}
{% block title %}Find Help Near Me â€“ NyayaShakti{% endblock %}

{% block extra_head %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
<style>
  .map-page {
    display: grid;
    grid-template-columns: 340px 1fr;
    height: calc(100vh - var(--nav-h));
    overflow: hidden;
  }

  /* â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .map-sidebar {
    background: #fff;
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .sidebar-header {
    padding: 24px 20px 16px;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }
  .sidebar-header h2 {
    font-family: var(--font-display);
    font-size: 26px;
    font-weight: 700;
    color: var(--charcoal);
    margin-bottom: 4px;
  }
  .sidebar-header p { font-size: 13px; color: var(--muted); }

  .filter-pills {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    padding: 14px 20px;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }
  .pill {
    padding: 6px 14px;
    border-radius: 50px;
    border: 1px solid var(--border);
    background: var(--ivory);
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    color: var(--slate);
  }
  .pill:hover, .pill.active {
    background: var(--crimson);
    border-color: var(--crimson);
    color: #fff;
  }

  .center-list {
    flex: 1;
    overflow-y: auto;
    padding: 12px 12px 12px;
  }
  .center-list::-webkit-scrollbar { width: 4px; }
  .center-list::-webkit-scrollbar-track { background: transparent; }
  .center-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .center-item {
    padding: 16px;
    border-radius: var(--radius);
    border: 1px solid var(--border);
    margin-bottom: 10px;
    cursor: pointer;
    transition: var(--transition);
    background: var(--ivory);
  }
  .center-item:hover, .center-item.active {
    border-color: var(--crimson);
    background: rgba(200,16,46,.04);
    box-shadow: var(--shadow-sm);
  }
  .center-item__header { display: flex; align-items: flex-start; gap: 10px; margin-bottom: 6px; }
  .center-item__type-icon {
    width: 36px; height: 36px;
    border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    font-size: 18px;
    flex-shrink: 0;
  }
  .type-police { background: rgba(59,130,246,.12); }
  .type-hospital { background: rgba(239,68,68,.1); }
  .type-support { background: rgba(168,85,247,.1); }
  .center-item__name { font-weight: 600; font-size: 14px; color: var(--charcoal); line-height: 1.3; }
  .center-item__addr { font-size: 12px; color: var(--muted); margin-top: 2px; }
  .center-item__meta { display: flex; align-items: center; gap: 8px; margin-top: 8px; }
  .center-item__phone { font-size: 13px; color: var(--crimson); font-weight: 600; text-decoration: none; }
  .center-item__hours { font-size: 11px; color: var(--muted); }

  /* â”€â”€ Locate Me Button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .locate-btn {
    margin: 0 12px 12px;
    padding: 12px;
    background: var(--crimson);
    color: #fff;
    border: none;
    border-radius: var(--radius);
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: var(--transition);
    flex-shrink: 0;
  }
  .locate-btn:hover { background: var(--crimson-dk); }

  /* â”€â”€ Map â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #map {
    width: 100%;
    height: 100%;
    z-index: 1;
  }

  /* Custom Leaflet popup */
  .leaflet-popup-content-wrapper {
    border-radius: 12px !important;
    box-shadow: var(--shadow-md) !important;
    font-family: var(--font-body) !important;
  }
  .popup-title { font-weight: 700; font-size: 15px; margin-bottom: 4px; color: var(--charcoal); }
  .popup-type { font-size: 11px; text-transform: uppercase; letter-spacing: .08em; color: var(--muted); margin-bottom: 8px; }
  .popup-phone { color: var(--crimson); font-weight: 600; font-size: 14px; text-decoration: none; }
  .popup-hours { font-size: 12px; color: var(--muted); margin-top: 4px; }
  .popup-nav {
    display: inline-block;
    margin-top: 10px;
    padding: 8px 16px;
    background: var(--crimson);
    color: #fff;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    text-decoration: none;
  }

  /* Mobile: stack vertically */
  @media (max-width: 768px) {
    .map-page {
      grid-template-columns: 1fr;
      grid-template-rows: auto 1fr;
      height: calc(100vh - var(--nav-h));
    }
    .map-sidebar {
      border-right: none;
      border-bottom: 1px solid var(--border);
      max-height: 45vh;
    }
    #map { min-height: 300px; }
  }
</style>
{% endblock %}

{% block content %}
<div class="map-page">

  <!-- Sidebar -->
  <aside class="map-sidebar">
    <div class="sidebar-header">
      <h2>ğŸ“ Help Near You</h2>
      <p>{{ help_centers|length }} centres available</p>
    </div>

    <div class="filter-pills">
      <button class="pill active" onclick="filterCenters('all', this)">ğŸ—ºï¸ All</button>
      <button class="pill" onclick="filterCenters('police', this)">ğŸš” Police</button>
      <button class="pill" onclick="filterCenters('hospital', this)">ğŸ¥ Hospital</button>
      <button class="pill" onclick="filterCenters('support', this)">ğŸ¤ Support</button>
    </div>

    <div class="center-list" id="centerList">
      <!-- Populated by JS -->
    </div>

    <button class="locate-btn" onclick="locateMe()">ğŸ“¡ Show My Location</button>
  </aside>

  <!-- Map -->
  <div id="map"></div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script>
  const CENTERS = {{ help_centers_json|safe }};

  const TYPE_META = {
    police:   { icon: 'ğŸš”', label: 'Police Station', color: '#3B82F6', css: 'type-police' },
    hospital: { icon: 'ğŸ¥', label: 'Hospital',        color: '#EF4444', css: 'type-hospital' },
    support:  { icon: 'ğŸ¤', label: 'Support Centre',  color: '#A855F7', css: 'type-support' },
  };

  // â”€â”€ Map Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const map = L.map('map', { zoomControl: true }).setView([9.654591517381945, 76.82790228567762], 13);

// Auto-detect user location on load and re-center
if (navigator.geolocation) {
  navigator.geolocation.getCurrentPosition(
    (pos) => {
      const { latitude: lat, longitude: lng } = pos.coords;
      map.flyTo([lat, lng], 14, { duration: 1.5 });
      L.circleMarker([lat, lng], {
        radius: 10, fillColor: '#3B82F6', color: '#fff',
        weight: 3, opacity: 1, fillOpacity: .9,
      }).addTo(map).bindPopup('ğŸ“ <strong>You are here</strong>').openPopup();
    },
    () => {} // silently fall back to default coords if denied
  );
}
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
    maxZoom: 19,
  }).addTo(map);

  // Custom markers
  function makeIcon(emoji, color) {
    return L.divIcon({
      html: `<div style="
        width:40px;height:40px;
        background:${color};
        border-radius:50% 50% 50% 4px;
        display:flex;align-items:center;justify-content:center;
        font-size:20px;
        box-shadow:0 4px 12px ${color}55;
        border:3px solid white;
        transform:rotate(-45deg);
        transition:transform .2s;
      "><span style="transform:rotate(45deg)">${emoji}</span></div>`,
      className: '',
      iconSize: [40, 40],
      iconAnchor: [20, 40],
      popupAnchor: [0, -44],
    });
  }

  const markers = [];
  let activeFilter = 'all';

  CENTERS.forEach(c => {
    const meta = TYPE_META[c.type] || TYPE_META.support;
    const marker = L.marker([c.lat, c.lng], { icon: makeIcon(meta.icon, meta.color) })
      .addTo(map)
      .bindPopup(`
        <div class="popup-title">${c.name}</div>
        <div class="popup-type">${meta.icon} ${meta.label}</div>
        <div style="font-size:13px;color:#666;margin-bottom:6px;">ğŸ“Œ ${c.address}</div>
        <a href="tel:${c.phone}" class="popup-phone">ğŸ“ ${c.phone}</a>
        <div class="popup-hours">ğŸ• ${c.hours}</div>
        <br>
        <a class="popup-nav" href="https://www.openstreetmap.org/directions?from=&to=${c.lat},${c.lng}" target="_blank">ğŸ—ºï¸ Get Directions</a>
      `, { maxWidth: 240 });

    markers.push({ center: c, marker });
  });

  // â”€â”€ Sidebar List â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderList(filter) {
    const list = document.getElementById('centerList');
    list.innerHTML = '';
    CENTERS.forEach(c => {
      if (filter !== 'all' && c.type !== filter) return;
      const meta = TYPE_META[c.type] || TYPE_META.support;
      const item = document.createElement('div');
      item.className = 'center-item';
      item.id = `item-${c.id}`;
      item.innerHTML = `
        <div class="center-item__header">
          <div class="center-item__type-icon ${meta.css}">${meta.icon}</div>
          <div>
            <div class="center-item__name">${c.name}</div>
            <div class="center-item__addr">${c.address}</div>
          </div>
        </div>
        <div class="center-item__meta">
          <a href="tel:${c.phone}" class="center-item__phone">ğŸ“ ${c.phone}</a>
          <span class="center-item__hours">Â· ${c.hours}</span>
        </div>
      `;
      item.addEventListener('click', () => {
        map.flyTo([c.lat, c.lng], 16, { duration: 1 });
        const m = markers.find(m => m.center.id === c.id);
        if (m) m.marker.openPopup();
        document.querySelectorAll('.center-item').forEach(el => el.classList.remove('active'));
        item.classList.add('active');
      });
      list.appendChild(item);
    });
  }

  function filterCenters(type, btn) {
    activeFilter = type;
    document.querySelectorAll('.pill').forEach(p => p.classList.remove('active'));
    btn.classList.add('active');
    markers.forEach(({ center, marker }) => {
      if (type === 'all' || center.type === type) {
        map.addLayer(marker);
      } else {
        map.removeLayer(marker);
      }
    });
    renderList(type);
  }

  // â”€â”€ Locate Me â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let userMarker = null;
  function locateMe() {
    if (!navigator.geolocation) { showToast('Geolocation not supported', 'error'); return; }
    showToast('Finding your locationâ€¦', '', 2000);
    navigator.geolocation.getCurrentPosition(pos => {
      const { latitude: lat, longitude: lng } = pos.coords;
      if (userMarker) map.removeLayer(userMarker);
      userMarker = L.circleMarker([lat, lng], {
        radius: 12, fillColor: '#3B82F6', color: '#fff',
        weight: 3, opacity: 1, fillOpacity: .85,
      }).addTo(map).bindPopup('ğŸ“ <strong>You are here</strong>').openPopup();
      map.flyTo([lat, lng], 15, { duration: 1.2 });
      showToast('Location found!', 'success');
    }, () => showToast('Could not access location. Check browser permissions.', 'error'));
  }

  renderList('all');
</script>
{% endblock %}
